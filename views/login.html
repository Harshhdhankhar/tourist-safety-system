<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Tourist Safety System</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;700&family=Noto+Sans+Bengali:wght@400;500;700&family=Noto+Sans+Telugu:wght@400;500;700&family=Noto+Sans+Tamil:wght@400;500;700&family=Noto+Sans+Urdu:wght@400;500;700&family=Noto+Sans+Kannada:wght@400;500;700&family=Noto+Sans+Malayalam:wght@400;500;700&family=Noto+Sans+Gurmukhi:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <h1>Tourist Safety System</h1>
            </div>
            <nav>
                <a href="/" class="btn btn-outline-small">
                    <i class="fas fa-home"></i> Home
                </a>
            </nav>
        </header>

        <main class="main-content">
            <div class="auth-card">
                <div class="auth-header">
                    <i class="fas fa-sign-in-alt"></i>
                    <h2>Login to Your Account</h2>
                    <p>Enter your credentials to access your account</p>
                </div>

                <!-- Simple Login Form -->
                <form id="loginForm" class="login-form">
                    <div class="form-group">
                        <label for="identifier">Email or Username *</label>
                        <input type="text" id="identifier" name="identifier" placeholder="Enter your email or username" required> 
                        <span class="error-message" id="identifierError"></span>
                    </div>

                    <div class="form-group">
                        <label for="password">Password *</label>
                        <div class="password-input">
                            <input type="password" id="password" name="password" placeholder="Enter your password" required> 
                            <button type="button" class="toggle-password" onclick="togglePassword()">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <span class="error-message" id="passwordError"></span>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-full">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    </div>
                </form>

                <p class="auth-switch">
                    Don't have an account? 
                    <a href="/register-indian" class="link">Register as Indian Tourist</a> | 
                    <a href="/register-foreign" class="link">Register as Foreign Tourist</a>
                </p>
            </div>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none !important;">
        <div class="spinner"></div>
        <p>Logging in...</p>
    </div>

    <style>
        .loading-overlay {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
    </style>
    
    <script>
        console.log('ðŸ”§ Inline script loaded');
        
        // Immediate loading overlay destruction
        const destroyLoadingOverlay = () => {
            const overlays = document.querySelectorAll('.loading-overlay, #loadingOverlay');
            overlays.forEach(overlay => {
                if (overlay) {
                    overlay.style.display = 'none';
                    overlay.style.visibility = 'hidden';
                    overlay.style.opacity = '0';
                    overlay.remove();
                }
            });
        };
        
        // Run immediately
        destroyLoadingOverlay();
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ“‹ DOM loaded, setting up login...');
            
            // Keep destroying loading overlays
            setInterval(destroyLoadingOverlay, 50);
            
            const loginForm = document.getElementById('loginForm');
            console.log('ðŸ“‹ Login form found:', !!loginForm);
            
            if (loginForm) {
                // Add both submit and button click handlers
                const handleLoginAttempt = async function() {
                    console.log('ðŸš€ Login attempt started');
                    
                    const identifier = loginForm.identifier.value.trim();
                    const password = loginForm.password.value;
                    
                    console.log('ðŸ“ Credentials:', { identifier, password: password ? '***' : 'empty' });
                    
                    if (!identifier || !password) {
                        alert('Please fill in all fields');
                        return;
                    }
                    
                    const overlay = document.getElementById('loadingOverlay');
                    overlay.style.display = 'flex';
                    console.log('â³ Loading shown');
                    
                    try {
                        console.log('ðŸ“¡ Sending login request to /api/auth/login');
                        const response = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ identifier, password })
                        });
                        
                        console.log('ðŸ“¡ Response status:', response.status);
                        const data = await response.json();
                        console.log('ðŸ“¦ Response data:', data);
                        
                        if (data.success) {
                            console.log('âœ… Login successful, storing token');
                            localStorage.setItem('authToken', data.token);
                            console.log('ðŸ”„ Redirecting to dashboard');
                            window.location.href = '/dashboard';
                        } else {
                            console.log('âŒ Login failed:', data.message);
                            overlay.style.display = 'none';
                            alert('Login failed: ' + (data.message || 'Unknown error'));
                        }
                    } catch (error) {
                        console.error('ðŸ’¥ Network/Server Error:', error);
                        overlay.style.display = 'none';
                        alert('Login failed. Please check your connection and try again.');
                    }
                };
                
                loginForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    console.log('ðŸ“‹ Form submit event triggered');
                    handleLoginAttempt();
                });
                
                // Also add click handler to login button as backup
                const loginButton = loginForm.querySelector('button[type="submit"]');
                if (loginButton) {
                    loginButton.addEventListener('click', function(event) {
                        event.preventDefault();
                        console.log('ðŸ”˜ Button click event triggered');
                        handleLoginAttempt();
                    });
                    console.log('âœ… Button click handler added');
                }
                
                console.log('âœ… Form submit handler added');
            }
            
            // Test if clicking anywhere triggers events
            document.addEventListener('click', function(e) {
                console.log('ðŸ–±ï¸ Click detected on:', e.target.tagName, e.target.type || 'no-type');
                
                // Force hide loading if it's stuck and trigger login manually
                if (e.target.tagName === 'BUTTON' && e.target.type === 'submit') {
                    console.log('ðŸ”˜ Login button clicked directly!');
                    
                    // Immediately hide any existing loading
                    const overlay = document.getElementById('loadingOverlay');
                    if (overlay) {
                        overlay.style.display = 'none';
                        console.log('ðŸ”„ Loading overlay hidden immediately');
                    }
                    
                    // Trigger login manually since event handlers aren't working
                    const form = document.getElementById('loginForm');
                    if (form) {
                        const identifier = form.identifier.value.trim();
                        const password = form.password.value;
                        
                        if (identifier && password) {
                            console.log('ðŸš€ Manual login trigger');
                            fetch('/api/auth/login', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ identifier, password })
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log('ðŸ“¦ Login response:', data);
                                if (data.success) {
                                    localStorage.setItem('authToken', data.token);
                                    window.location.href = '/dashboard';
                                } else {
                                    alert('Login failed: ' + (data.message || 'Unknown error'));
                                }
                            })
                            .catch(error => {
                                console.error('ðŸ’¥ Login error:', error);
                                alert('Login failed. Please try again.');
                            });
                        } else {
                            alert('Please fill in all fields');
                        }
                    }
                }
            });
            
            // Password toggle
            window.togglePassword = function() {
                const passwordInput = document.getElementById('password');
                const toggleBtn = document.querySelector('.toggle-password i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleBtn.className = 'fas fa-eye-slash';
                } else {
                    passwordInput.type = 'password';
                    toggleBtn.className = 'fas fa-eye';
                }
            };
        });
    </script>
</body>
</html>
